<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CI terraform | Bpaulin.net</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="MÃªme les outils de dÃ©ploiements mÃ©ritent une CI">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.dc9257eb.css" as="style"><link rel="preload" href="/assets/js/app.fe96221c.js" as="script"><link rel="preload" href="/assets/js/6.5adf3b91.js" as="script"><link rel="preload" href="/assets/js/3.04bbc949.js" as="script"><link rel="preload" href="/assets/js/46.b29251f0.js" as="script"><link rel="prefetch" href="/assets/js/10.90a950bb.js"><link rel="prefetch" href="/assets/js/11.24bf25f5.js"><link rel="prefetch" href="/assets/js/12.5f0cd5db.js"><link rel="prefetch" href="/assets/js/13.678a6ec4.js"><link rel="prefetch" href="/assets/js/14.f7077979.js"><link rel="prefetch" href="/assets/js/15.44f0261e.js"><link rel="prefetch" href="/assets/js/16.8a6756a3.js"><link rel="prefetch" href="/assets/js/17.56537411.js"><link rel="prefetch" href="/assets/js/18.ee4fdda2.js"><link rel="prefetch" href="/assets/js/19.d0261b2d.js"><link rel="prefetch" href="/assets/js/20.caeb6cc6.js"><link rel="prefetch" href="/assets/js/21.5d72c957.js"><link rel="prefetch" href="/assets/js/22.280a0ba3.js"><link rel="prefetch" href="/assets/js/23.f43d2ff6.js"><link rel="prefetch" href="/assets/js/24.0111e63c.js"><link rel="prefetch" href="/assets/js/25.9e5a3246.js"><link rel="prefetch" href="/assets/js/26.39eb4a22.js"><link rel="prefetch" href="/assets/js/27.c1c85d1f.js"><link rel="prefetch" href="/assets/js/28.676c500d.js"><link rel="prefetch" href="/assets/js/29.13e711ae.js"><link rel="prefetch" href="/assets/js/30.e702a14a.js"><link rel="prefetch" href="/assets/js/31.48758f3e.js"><link rel="prefetch" href="/assets/js/32.80d216a3.js"><link rel="prefetch" href="/assets/js/33.15c5de30.js"><link rel="prefetch" href="/assets/js/34.201c95e2.js"><link rel="prefetch" href="/assets/js/35.2bc1c5c3.js"><link rel="prefetch" href="/assets/js/36.8d287362.js"><link rel="prefetch" href="/assets/js/37.bd68b395.js"><link rel="prefetch" href="/assets/js/38.9e0c5a37.js"><link rel="prefetch" href="/assets/js/39.5e6287ce.js"><link rel="prefetch" href="/assets/js/4.8ed5f86b.js"><link rel="prefetch" href="/assets/js/40.f84a637d.js"><link rel="prefetch" href="/assets/js/41.f40f0a83.js"><link rel="prefetch" href="/assets/js/42.3184aa4d.js"><link rel="prefetch" href="/assets/js/43.d61477f1.js"><link rel="prefetch" href="/assets/js/44.2c4d8bd3.js"><link rel="prefetch" href="/assets/js/45.e0a94445.js"><link rel="prefetch" href="/assets/js/47.590000d5.js"><link rel="prefetch" href="/assets/js/5.324dd201.js"><link rel="prefetch" href="/assets/js/7.480c33b5.js"><link rel="prefetch" href="/assets/js/8.74b7553c.js"><link rel="prefetch" href="/assets/js/9.629a5071.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.1dddff6e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.dc9257eb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Bpaulin.net </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Articles</a></li><li class="nav-item"><a href="/about/" class="nav-link">About</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Bpaulin.net </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Articles</a></li><li class="mobile-nav-item"><a href="/about/" class="nav-link">About</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        CI terraform
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2022-09-17T00:00:00.000Z">
      2022-09-17
    </time></div> <!----></div></header> <div itemprop="articleBody" class="content__default"><p>J'aime pas terraform. Je n'ai jamais compris l'interet du tfstate mais j'en ai dÃ©ja subi les inconvenients. Je ne suis mÃªme pas convaincu de l'interet du produit: pourquoi utiliser un outil qui peut tout faire pour des envs mono cloud, pourquoi ne pas utiliser directement les api ou cli fournis par ce mÃªme cloud provider.</p> <p>Sauf que...</p> <p>Si autant l'utilisent c'est soit que je suis le seul Ã  avoir raison (donc non) soit que j'ai tord. Terraform est devenu de facto l'outil pour crÃ©er des resources cloud, et les recruteurs le demandent(...).</p> <blockquote><p>Si c'est pas versionnÃ©, c'est nul. si c'est versionnÃ©, ca doit avoir un CI</p></blockquote> <p>Donc youpi, side project #78587: le CI d'un projet terraform</p> <h2 id="projet-terraform"><a href="#projet-terraform" class="header-anchor">#</a> Projet terraform</h2> <p>Totalement par hasard et sans lien avec des discutions rÃ©centes(...) je vais partir sur la crÃ©ation d'un cluster eks, le kube managÃ© sur aws.</p> <p>Toujours par hasard, hashicorp utilise justement ce cas dans leurs tutos, quel incroyable coincidence! A se demander si j'ai pas choisi ca pour pouvoir aller plus vite vers la partie qui m'interesse aujourd'hui</p> <p>Un fork de https://github.com/hashicorp/learn-terraform-provision-eks-cluster sur mon github, un clone local et je peux avancer.</p> <p>L'authentification sur aws n'est pas le sujet, je passe la creation des clÃ©s mais je les exporte dans mon shell.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_ACCESS_KEY_ID</span><span class="token operator">=</span><span class="token string">&quot;cestsecret&quot;</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_SECRET_ACCESS_KEY</span><span class="token operator">=</span><span class="token string">&quot;cestsupersecret&quot;</span>
</code></pre></div><p>J'initialise terraform. Dans ce cas simpliste, c'est un grand mot pour dire que terraform va tÃ©lÃ©charger les providers demandÃ©s (aws en particulier). Pour cet article, je me rajoute une contrainte: autant que possible, les outils doivent Ãªtre lancÃ© via docker sans installation locale.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> AWS_ACCESS_KEY_ID <span class="token parameter variable">-e</span> AWS_SECRET_ACCESS_KEY <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>:/src&quot;</span> <span class="token parameter variable">-w</span> <span class="token string">'/src'</span> <span class="token punctuation">\</span>
  hashicorp/terraform:1.2.9 <span class="token punctuation">\</span>
  init
</code></pre></div><p>Et je <code>plan</code> terraform, pour tester la communication avec aws et voir ce qu'il va me crÃ©er.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> AWS_ACCESS_KEY_ID <span class="token parameter variable">-e</span> AWS_SECRET_ACCESS_KEY <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>:/src&quot;</span> <span class="token parameter variable">-w</span> <span class="token string">'/src'</span> <span class="token punctuation">\</span>
  hashicorp/terraform:1.2.9 <span class="token punctuation">\</span>
  plan
</code></pre></div><p>Le log me montre tout ce qui va Ãªtre crÃ©Ã©, Ã  savoir pleins de trucs.</p> <div class="language- extra-class"><pre class="language-text"><code>Plan: 56 to add, 0 to change, 0 to destroy.
</code></pre></div><p>C'est trop facile terraform, quel scandale d'Ãªtre payÃ© autant pour faire du copier coller</p> <blockquote><p>The beauty and clearness of the dynamical theory, which asserts heat and light to be modes of motion, is at present obscured by two clouds.</p></blockquote> <p>2 petits nuages restent, 2 minuscules nuages:</p> <ul><li>Est ce que c'est prod ready? (n'importe quel tutoriel trouvÃ© sur internet est prod ready, ne soyons pas parano)</li> <li>Combien ca va couter? (surement quasiment rien, pas d'inquietude)</li></ul> <h2 id="prod-ready"><a href="#prod-ready" class="header-anchor">#</a> Prod ready?</h2> <p>Clairement, une analyse statique du code ne couvrira qu'une partie des problÃ¨mes. Le sizing de l'infra va se manger la rÃ©alitÃ© pleine gueule. Les perfs seront Ã  revoir, la rÃ©silience sera Ã  tester. Chaque 0.1% de dispo va couter plus cher que le prÃ©cÃ©dent, Chaque Ã©volution des technos et des versions vont remettre en cause ce qu'on croit savoir.</p> <p>Par contre l'analyse statique de code a un avantage incomparable: avec trÃ¨s peu d'effort, on couvre 90% (random chiffre, basÃ© sur 'vas y crois moi') des failles/erreurs de conception ou d'implementation. Par definition on peut lancer ces analyses sans meme avoir besoin de commencer a payer les evols. Et surtout, surtout! on se base sur des rÃ¨gles et pratiques issues de la communautÃ©e mondiale des users, forcement plus fiables que celles qu'un unique reviewer aura en tete.</p> <h3 id="tflint-pour-du-code-bien-ecrit"><a href="#tflint-pour-du-code-bien-ecrit" class="header-anchor">#</a> tflint, pour du code 'bien' ecrit</h3> <blockquote><p>TFLint is a framework and each feature is provided by plugins, the key features are as follows:</p> <ul><li>Find possible errors (like invalid instance types) for Major Cloud providers (AWS/Azure/GCP).</li> <li>Warn about deprecated syntax, unused declarations.</li> <li>Enforce best practices, naming conventions.</li></ul></blockquote> <p>C'est bien ecrit hein? c'est un readme, c'est normal. tflint va me permettre sans efforts et rapidement de verifier que les evols de mon code n'apportent pas une erreur. En bonus, tflint va vÃ©rifier les bonnes pratiques pour les 3 principaux cloud providers occidentaux (aws, gcp, azure).</p> <p>La config est rapide, j'indique juste dans le fichier <code>.tflint.hcl</code> que je veux qu'il analyse la structure terraform et les resources aws.</p> <div class="language-hcl extra-class"><pre class="language-hcl"><code>plugin <span class="token string">&quot;terraform&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">enabled</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">preset</span>  <span class="token punctuation">=</span> <span class="token string">&quot;recommended&quot;</span>
<span class="token punctuation">}</span>

plugin <span class="token string">&quot;aws&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">enabled</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Le lancement, comme pour terraform, se fait via docker:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-t</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>:/data <span class="token punctuation">\</span>
  ghcr.io/terraform-linters/tflint-bundle:v0.40.1.0
</code></pre></div><p>et paf, mon code n'est pas aussi propre que je pensais ðŸ˜¦</p> <div class="language- extra-class"><pre class="language-text"><code>1 issue(s) found:

Warning: Missing version constraint for provider &quot;kubernetes&quot; in &quot;required_providers&quot; (terraform_required_providers)

  on main.tf line 6:
   6: provider &quot;kubernetes&quot; {

Reference: https://github.com/terraform-linters/tflint-ruleset-terraform/blob/v0.1.1/docs/rules/terraform_required_providers.md
</code></pre></div><p>J'ai effectivement un petit problÃ¨me: ma version du provider kube est totalement libre, je prends le risque d'une execution sur une version jamais testÃ©e, ou trop vieille. tflint me donne meme un lien qui m'explique quoi faire. La correction est simple, il suffit d'editer le fichier <code>versions.tf</code></p> <div class="language-hcl extra-class"><pre class="language-hcl"><code><span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token comment"># ...</span>
    <span class="token property">kubernetes</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">&quot;hashicorp/kubernetes&quot;</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;~&gt; 2.13.0&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>et tflint ne trouve plus rien a dire, un <a href="https://github.com/bpaulin/learn-terraform-provision-eks-cluster/commit/78c78a2e36984b0ad256b3095fbf0fd5c2748478" target="_blank" rel="noopener noreferrer">commit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> et on enchaine avec l'outil suivant</p> <h3 id="tfsec-devsecops"><a href="#tfsec-devsecops" class="header-anchor">#</a> tfsec, DevSecOps</h3> <p>tfsec va faire la meme chose que tflint, mais plus axÃ© sur les eventuels problÃ¨mes de sÃ©curitÃ©. Le lancement, comme toujours, n'a besoin que de docker. TrÃ¨s confiant sur la sÃ©curitÃ© poussÃ©e d'un tutoriel trouvÃ© sur internet, je lance la commande</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>:/src&quot;</span> <span class="token punctuation">\</span>
  aquasec/tfsec:v1.27 <span class="token punctuation">\</span>
  /src
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>  results
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  passed               38
  ignored              0
  critical             5
  high                 2
  medium               2
  low                  4

  38 passed, 13 potential problem(s) detected.
</code></pre></div><p>13 failles, 5 critiques... oh bah large, allons en prod rassurÃ©s. tfsec permet un export markdown, entre autre, qui me permet de detailler tout ca</p> <table><thead><tr><th>#</th> <th>ID</th> <th>Severity</th> <th>Title</th> <th>Location</th> <th>Description</th></tr></thead> <tbody><tr><td>1</td> <td><code>aws-ec2-add-description-to-security-group</code></td> <td><em>LOW</em></td> <td><em>Missing description for security group.</em></td> <td><code>security-groups.tf:16-29</code></td> <td>Security group explicitly uses the default description.</td></tr> <tr><td>2</td> <td><code>aws-ec2-add-description-to-security-group</code></td> <td><em>LOW</em></td> <td><em>Missing description for security group.</em></td> <td><code>security-groups.tf:1-14</code></td> <td>Security group explicitly uses the default description.</td></tr> <tr><td>3</td> <td><code>aws-ec2-add-description-to-security-group-rule</code></td> <td><em>LOW</em></td> <td><em>Missing description for security group rule.</em></td> <td><code>security-groups.tf:5-13</code></td> <td>Security group rule does not have a description.</td></tr> <tr><td>4</td> <td><code>aws-ec2-add-description-to-security-group-rule</code></td> <td><em>LOW</em></td> <td><em>Missing description for security group rule.</em></td> <td><code>security-groups.tf:20-28</code></td> <td>Security group rule does not have a description.</td></tr> <tr><td>5</td> <td><code>aws-ec2-no-public-egress-sgr</code></td> <td><em>CRITICAL</em></td> <td><em>An egress security group rule allows traffic to /0.</em></td> <td><code>terraform-aws-modules/eks/aws/src/.terraform/modules/eks/node_groups.tf:182</code></td> <td>Security group rule allows egress to multiple public internet addresses.</td></tr> <tr><td>6</td> <td><code>aws-ec2-no-public-egress-sgr</code></td> <td><em>CRITICAL</em></td> <td><em>An egress security group rule allows traffic to /0.</em></td> <td><code>terraform-aws-modules/eks/aws/src/.terraform/modules/eks/node_groups.tf:182</code></td> <td>Security group rule allows egress to multiple public internet addresses.</td></tr> <tr><td>7</td> <td><code>aws-ec2-no-public-egress-sgr</code></td> <td><em>CRITICAL</em></td> <td><em>An egress security group rule allows traffic to /0.</em></td> <td><code>terraform-aws-modules/eks/aws/src/.terraform/modules/eks/node_groups.tf:182</code></td> <td>Security group rule allows egress to multiple public internet addresses.</td></tr> <tr><td>8</td> <td><code>aws-ec2-no-public-ip-subnet</code></td> <td><em>HIGH</em></td> <td><em>Instances in a subnet should not receive a public IP address by default.</em></td> <td><code>terraform-aws-modules/vpc/aws/src/.terraform/modules/vpc/main.tf:359</code></td> <td>Subnet associates public IP address.</td></tr> <tr><td>9</td> <td><code>aws-eks-enable-control-plane-logging</code></td> <td><em>MEDIUM</em></td> <td><em>EKS Clusters should have cluster control plane logging turned on</em></td> <td><code>terraform-aws-modules/eks/aws/src/.terraform/modules/eks/main.tf:14-63</code></td> <td>Control plane controller manager logging is not enabled.</td></tr> <tr><td>10</td> <td><code>aws-eks-enable-control-plane-logging</code></td> <td><em>MEDIUM</em></td> <td><em>EKS Clusters should have cluster control plane logging turned on</em></td> <td><code>terraform-aws-modules/eks/aws/src/.terraform/modules/eks/main.tf:14-63</code></td> <td>Control plane scheduler logging is not enabled.</td></tr> <tr><td>11</td> <td><code>aws-eks-encrypt-secrets</code></td> <td><em>HIGH</em></td> <td><em>EKS should have the encryption of secrets enabled</em></td> <td><code>terraform-aws-modules/eks/aws/src/.terraform/modules/eks/main.tf:14-63</code></td> <td>Cluster does not have secret encryption enabled.</td></tr> <tr><td>12</td> <td><code>aws-eks-no-public-cluster-access</code></td> <td><em>CRITICAL</em></td> <td><em>EKS Clusters should have the public access disabled</em></td> <td><code>terraform-aws-modules/eks/aws/src/.terraform/modules/eks/main.tf:26</code></td> <td>Public cluster access is enabled.</td></tr> <tr><td>13</td> <td><code>aws-eks-no-public-cluster-access-to-cidr</code></td> <td><em>CRITICAL</em></td> <td><em>EKS cluster should not have open CIDR range for public access</em></td> <td><code>terraform-aws-modules/eks/aws/src/.terraform/modules/eks/main.tf:27</code></td> <td>Cluster allows access from a public CIDR: 0.0.0.0/0.</td></tr></tbody></table> <p>Le cluster est public, les secrets sont en clair, le logging n'est pas activÃ©... sans maitriser aws, il va falloir faire l'effort de regler chaque problÃ¨me ou si on peut <strong>vraiment</strong> le justifier, annoter les tf pour exclure une remontÃ©e.</p> <p>Je suis surpris du nombre de failles trouvÃ©es, il y en a trop pour dÃ©tailler la resolution ici. Je le ferai peut etre un jour (ahahah non, je vais passer sur sideproject #85379876 c'est plus probable).</p> <h2 id="infracost-le-nerf-de-la-guerre"><a href="#infracost-le-nerf-de-la-guerre" class="header-anchor">#</a> infracost, le nerf de la guerre</h2> <p>Evidemment que le cloud est gÃ©nial, c'est reactif, moderne, facile. On peut heberger n'importe quoi sur n'importe quel techno avec n'importe quelle puissance en quelques lignes de codes... et Ã  la fin du mois, on recoit la facture. C'est le cofidis des datacenters, une reserve de puissance phenomenale accessible facilement... et un cout qui peut s'envoler tres haut, tres vite, trop tard.</p> <p>Mais comme il existe des apps pour suivre et prevoir un budget (...) il existe une app pour prevoir les couts du cloud.</p> <p>Infracost fournit pleins de trucs, des abonnements avec des dashboards pour suivre l'evolution des couts. Pour mon cas, je vais juste utiliser leur cli pour avoir une idÃ©e du cout de ce petit tutoriel bien ecrit (oui) et sans failles (non).</p> <p>Il faut une api key meme pour le free tier, que je pose en var d'env dans mon shell</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">INFRACOST_API_KEY</span><span class="token operator">=</span>olalalacestsecret
</code></pre></div><p>Et comme precedemment, le lancement se fait via docker</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> INFRACOST_API_KEY <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> <span class="token environment constant">$PWD</span>/:/code/ infracost/infracost:ci-0.10.11 <span class="token punctuation">\</span>
  breakdown <span class="token parameter variable">--path</span> /code/
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code> OVERALL TOTAL                                                                                                      $170.24
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
53 cloud resources were detected:
âˆ™ 6 were estimated, 4 of which include usage-based costs, see https://infracost.io/usage-file
âˆ™ 47 were free, rerun with --show-skipped to see details
</code></pre></div><p>$170 par mois! et encore, infracost me signale que certaines resources sont facturÃ©es a l'usage et ne sont pas dans le chiffrage.</p> <h2 id="ensuite"><a href="#ensuite" class="header-anchor">#</a> Ensuite?</h2> <p>Tout ces outils s'integrent via github actions, mais cet article est deja assez long.</p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#projet-terraform" title="Projet terraform">Projet terraform</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#prod-ready" title="Prod ready?">Prod ready?</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#tflint-pour-du-code-bien-ecrit" title="tflint, pour du code 'bien' ecrit">tflint, pour du code 'bien' ecrit</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#tfsec-devsecops" title="tfsec, DevSecOps">tfsec, DevSecOps</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#infracost-le-nerf-de-la-guerre" title="infracost, le nerf de la guerre">infracost, le nerf de la guerre</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#ensuite" title="Ensuite?">Ensuite?</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/bpaulin" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="https://www.linkedin.com/in/bpaulin-devops" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin" data-v-3d9deeb8><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" data-v-3d9deeb8></path><rect x="2" y="9" width="4" height="12" data-v-3d9deeb8></rect><circle cx="4" cy="4" r="2" data-v-3d9deeb8></circle></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fe96221c.js" defer></script><script src="/assets/js/6.5adf3b91.js" defer></script><script src="/assets/js/3.04bbc949.js" defer></script><script src="/assets/js/46.b29251f0.js" defer></script>
  </body>
</html>

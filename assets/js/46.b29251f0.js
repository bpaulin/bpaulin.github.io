(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{342:function(e,s,t){"use strict";t.r(s);var a=t(5),r=Object(a.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("p",[e._v("J'aime pas terraform. Je n'ai jamais compris l'interet du tfstate mais j'en ai déja subi les inconvenients. Je ne suis même pas convaincu de l'interet du produit: pourquoi utiliser un outil qui peut tout faire pour des envs mono cloud, pourquoi ne pas utiliser directement les api ou cli fournis par ce même cloud provider.")]),e._v(" "),s("p",[e._v("Sauf que...")]),e._v(" "),s("p",[e._v("Si autant l'utilisent c'est soit que je suis le seul à avoir raison (donc non) soit que j'ai tord. Terraform est devenu de facto l'outil pour créer des resources cloud, et les recruteurs le demandent(...).")]),e._v(" "),s("blockquote",[s("p",[e._v("Si c'est pas versionné, c'est nul. si c'est versionné, ca doit avoir un CI")])]),e._v(" "),s("p",[e._v("Donc youpi, side project #78587: le CI d'un projet terraform")]),e._v(" "),s("h2",{attrs:{id:"projet-terraform"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#projet-terraform"}},[e._v("#")]),e._v(" Projet terraform")]),e._v(" "),s("p",[e._v("Totalement par hasard et sans lien avec des discutions récentes(...) je vais partir sur la création d'un cluster eks, le kube managé sur aws.")]),e._v(" "),s("p",[e._v("Toujours par hasard, hashicorp utilise justement ce cas dans leurs tutos, quel incroyable coincidence! A se demander si j'ai pas choisi ca pour pouvoir aller plus vite vers la partie qui m'interesse aujourd'hui")]),e._v(" "),s("p",[e._v("Un fork de https://github.com/hashicorp/learn-terraform-provision-eks-cluster sur mon github, un clone local et je peux avancer.")]),e._v(" "),s("p",[e._v("L'authentification sur aws n'est pas le sujet, je passe la creation des clés mais je les exporte dans mon shell.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("AWS_ACCESS_KEY_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"cestsecret"')]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("AWS_SECRET_ACCESS_KEY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"cestsupersecret"')]),e._v("\n")])])]),s("p",[e._v("J'initialise terraform. Dans ce cas simpliste, c'est un grand mot pour dire que terraform va télécharger les providers demandés (aws en particulier). Pour cet article, je me rajoute une contrainte: autant que possible, les outils doivent être lancé via docker sans installation locale.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--rm")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-it")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-e")]),e._v(" AWS_ACCESS_KEY_ID "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-e")]),e._v(" AWS_SECRET_ACCESS_KEY "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-v")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("pwd")]),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v(':/src"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-w")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'/src'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  hashicorp/terraform:1.2.9 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  init\n")])])]),s("p",[e._v("Et je "),s("code",[e._v("plan")]),e._v(" terraform, pour tester la communication avec aws et voir ce qu'il va me créer.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--rm")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-it")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-e")]),e._v(" AWS_ACCESS_KEY_ID "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-e")]),e._v(" AWS_SECRET_ACCESS_KEY "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-v")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("pwd")]),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v(':/src"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-w")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'/src'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  hashicorp/terraform:1.2.9 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  plan\n")])])]),s("p",[e._v("Le log me montre tout ce qui va être créé, à savoir pleins de trucs.")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("Plan: 56 to add, 0 to change, 0 to destroy.\n")])])]),s("p",[e._v("C'est trop facile terraform, quel scandale d'être payé autant pour faire du copier coller")]),e._v(" "),s("blockquote",[s("p",[e._v("The beauty and clearness of the dynamical theory, which asserts heat and light to be modes of motion, is at present obscured by two clouds.")])]),e._v(" "),s("p",[e._v("2 petits nuages restent, 2 minuscules nuages:")]),e._v(" "),s("ul",[s("li",[e._v("Est ce que c'est prod ready? (n'importe quel tutoriel trouvé sur internet est prod ready, ne soyons pas parano)")]),e._v(" "),s("li",[e._v("Combien ca va couter? (surement quasiment rien, pas d'inquietude)")])]),e._v(" "),s("h2",{attrs:{id:"prod-ready"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#prod-ready"}},[e._v("#")]),e._v(" Prod ready?")]),e._v(" "),s("p",[e._v("Clairement, une analyse statique du code ne couvrira qu'une partie des problèmes. Le sizing de l'infra va se manger la réalité pleine gueule. Les perfs seront à revoir, la résilience sera à tester. Chaque 0.1% de dispo va couter plus cher que le précédent, Chaque évolution des technos et des versions vont remettre en cause ce qu'on croit savoir.")]),e._v(" "),s("p",[e._v("Par contre l'analyse statique de code a un avantage incomparable: avec très peu d'effort, on couvre 90% (random chiffre, basé sur 'vas y crois moi') des failles/erreurs de conception ou d'implementation. Par definition on peut lancer ces analyses sans meme avoir besoin de commencer a payer les evols. Et surtout, surtout! on se base sur des règles et pratiques issues de la communautée mondiale des users, forcement plus fiables que celles qu'un unique reviewer aura en tete.")]),e._v(" "),s("h3",{attrs:{id:"tflint-pour-du-code-bien-ecrit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tflint-pour-du-code-bien-ecrit"}},[e._v("#")]),e._v(" tflint, pour du code 'bien' ecrit")]),e._v(" "),s("blockquote",[s("p",[e._v("TFLint is a framework and each feature is provided by plugins, the key features are as follows:")]),e._v(" "),s("ul",[s("li",[e._v("Find possible errors (like invalid instance types) for Major Cloud providers (AWS/Azure/GCP).")]),e._v(" "),s("li",[e._v("Warn about deprecated syntax, unused declarations.")]),e._v(" "),s("li",[e._v("Enforce best practices, naming conventions.")])])]),e._v(" "),s("p",[e._v("C'est bien ecrit hein? c'est un readme, c'est normal. tflint va me permettre sans efforts et rapidement de verifier que les evols de mon code n'apportent pas une erreur. En bonus, tflint va vérifier les bonnes pratiques pour les 3 principaux cloud providers occidentaux (aws, gcp, azure).")]),e._v(" "),s("p",[e._v("La config est rapide, j'indique juste dans le fichier "),s("code",[e._v(".tflint.hcl")]),e._v(" que je veux qu'il analyse la structure terraform et les resources aws.")]),e._v(" "),s("div",{staticClass:"language-hcl extra-class"},[s("pre",{pre:!0,attrs:{class:"language-hcl"}},[s("code",[e._v("plugin "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"terraform"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v("enabled")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v("preset")]),e._v("  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"recommended"')]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\nplugin "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"aws"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v("enabled")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("Le lancement, comme pour terraform, se fait via docker:")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--rm")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-t")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-v")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("pwd")]),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v(":/data "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  ghcr.io/terraform-linters/tflint-bundle:v0.40.1.0\n")])])]),s("p",[e._v("et paf, mon code n'est pas aussi propre que je pensais 😦")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('1 issue(s) found:\n\nWarning: Missing version constraint for provider "kubernetes" in "required_providers" (terraform_required_providers)\n\n  on main.tf line 6:\n   6: provider "kubernetes" {\n\nReference: https://github.com/terraform-linters/tflint-ruleset-terraform/blob/v0.1.1/docs/rules/terraform_required_providers.md\n')])])]),s("p",[e._v("J'ai effectivement un petit problème: ma version du provider kube est totalement libre, je prends le risque d'une execution sur une version jamais testée, ou trop vieille. tflint me donne meme un lien qui m'explique quoi faire. La correction est simple, il suffit d'editer le fichier "),s("code",[e._v("versions.tf")])]),e._v(" "),s("div",{staticClass:"language-hcl extra-class"},[s("pre",{pre:!0,attrs:{class:"language-hcl"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("terraform")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("required_providers")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# ...")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v("kubernetes")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v("source")]),e._v("  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"hashicorp/kubernetes"')]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v("version")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"~> 2.13.0"')]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# ...")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("et tflint ne trouve plus rien a dire, un "),s("a",{attrs:{href:"https://github.com/bpaulin/learn-terraform-provision-eks-cluster/commit/78c78a2e36984b0ad256b3095fbf0fd5c2748478",target:"_blank",rel:"noopener noreferrer"}},[e._v("commit"),s("OutboundLink")],1),e._v(" et on enchaine avec l'outil suivant")]),e._v(" "),s("h3",{attrs:{id:"tfsec-devsecops"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tfsec-devsecops"}},[e._v("#")]),e._v(" tfsec, DevSecOps")]),e._v(" "),s("p",[e._v("tfsec va faire la meme chose que tflint, mais plus axé sur les eventuels problèmes de sécurité. Le lancement, comme toujours, n'a besoin que de docker. Très confiant sur la sécurité poussée d'un tutoriel trouvé sur internet, je lance la commande")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--rm")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-it")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-v")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("pwd")]),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v(':/src"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  aquasec/tfsec:v1.27 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  /src\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("  results\n  ──────────────────────────────────────────\n  passed               38\n  ignored              0\n  critical             5\n  high                 2\n  medium               2\n  low                  4\n\n  38 passed, 13 potential problem(s) detected.\n")])])]),s("p",[e._v("13 failles, 5 critiques... oh bah large, allons en prod rassurés. tfsec permet un export markdown, entre autre, qui me permet de detailler tout ca")]),e._v(" "),s("table",[s("thead",[s("tr",[s("th",[e._v("#")]),e._v(" "),s("th",[e._v("ID")]),e._v(" "),s("th",[e._v("Severity")]),e._v(" "),s("th",[e._v("Title")]),e._v(" "),s("th",[e._v("Location")]),e._v(" "),s("th",[e._v("Description")])])]),e._v(" "),s("tbody",[s("tr",[s("td",[e._v("1")]),e._v(" "),s("td",[s("code",[e._v("aws-ec2-add-description-to-security-group")])]),e._v(" "),s("td",[s("em",[e._v("LOW")])]),e._v(" "),s("td",[s("em",[e._v("Missing description for security group.")])]),e._v(" "),s("td",[s("code",[e._v("security-groups.tf:16-29")])]),e._v(" "),s("td",[e._v("Security group explicitly uses the default description.")])]),e._v(" "),s("tr",[s("td",[e._v("2")]),e._v(" "),s("td",[s("code",[e._v("aws-ec2-add-description-to-security-group")])]),e._v(" "),s("td",[s("em",[e._v("LOW")])]),e._v(" "),s("td",[s("em",[e._v("Missing description for security group.")])]),e._v(" "),s("td",[s("code",[e._v("security-groups.tf:1-14")])]),e._v(" "),s("td",[e._v("Security group explicitly uses the default description.")])]),e._v(" "),s("tr",[s("td",[e._v("3")]),e._v(" "),s("td",[s("code",[e._v("aws-ec2-add-description-to-security-group-rule")])]),e._v(" "),s("td",[s("em",[e._v("LOW")])]),e._v(" "),s("td",[s("em",[e._v("Missing description for security group rule.")])]),e._v(" "),s("td",[s("code",[e._v("security-groups.tf:5-13")])]),e._v(" "),s("td",[e._v("Security group rule does not have a description.")])]),e._v(" "),s("tr",[s("td",[e._v("4")]),e._v(" "),s("td",[s("code",[e._v("aws-ec2-add-description-to-security-group-rule")])]),e._v(" "),s("td",[s("em",[e._v("LOW")])]),e._v(" "),s("td",[s("em",[e._v("Missing description for security group rule.")])]),e._v(" "),s("td",[s("code",[e._v("security-groups.tf:20-28")])]),e._v(" "),s("td",[e._v("Security group rule does not have a description.")])]),e._v(" "),s("tr",[s("td",[e._v("5")]),e._v(" "),s("td",[s("code",[e._v("aws-ec2-no-public-egress-sgr")])]),e._v(" "),s("td",[s("em",[e._v("CRITICAL")])]),e._v(" "),s("td",[s("em",[e._v("An egress security group rule allows traffic to /0.")])]),e._v(" "),s("td",[s("code",[e._v("terraform-aws-modules/eks/aws/src/.terraform/modules/eks/node_groups.tf:182")])]),e._v(" "),s("td",[e._v("Security group rule allows egress to multiple public internet addresses.")])]),e._v(" "),s("tr",[s("td",[e._v("6")]),e._v(" "),s("td",[s("code",[e._v("aws-ec2-no-public-egress-sgr")])]),e._v(" "),s("td",[s("em",[e._v("CRITICAL")])]),e._v(" "),s("td",[s("em",[e._v("An egress security group rule allows traffic to /0.")])]),e._v(" "),s("td",[s("code",[e._v("terraform-aws-modules/eks/aws/src/.terraform/modules/eks/node_groups.tf:182")])]),e._v(" "),s("td",[e._v("Security group rule allows egress to multiple public internet addresses.")])]),e._v(" "),s("tr",[s("td",[e._v("7")]),e._v(" "),s("td",[s("code",[e._v("aws-ec2-no-public-egress-sgr")])]),e._v(" "),s("td",[s("em",[e._v("CRITICAL")])]),e._v(" "),s("td",[s("em",[e._v("An egress security group rule allows traffic to /0.")])]),e._v(" "),s("td",[s("code",[e._v("terraform-aws-modules/eks/aws/src/.terraform/modules/eks/node_groups.tf:182")])]),e._v(" "),s("td",[e._v("Security group rule allows egress to multiple public internet addresses.")])]),e._v(" "),s("tr",[s("td",[e._v("8")]),e._v(" "),s("td",[s("code",[e._v("aws-ec2-no-public-ip-subnet")])]),e._v(" "),s("td",[s("em",[e._v("HIGH")])]),e._v(" "),s("td",[s("em",[e._v("Instances in a subnet should not receive a public IP address by default.")])]),e._v(" "),s("td",[s("code",[e._v("terraform-aws-modules/vpc/aws/src/.terraform/modules/vpc/main.tf:359")])]),e._v(" "),s("td",[e._v("Subnet associates public IP address.")])]),e._v(" "),s("tr",[s("td",[e._v("9")]),e._v(" "),s("td",[s("code",[e._v("aws-eks-enable-control-plane-logging")])]),e._v(" "),s("td",[s("em",[e._v("MEDIUM")])]),e._v(" "),s("td",[s("em",[e._v("EKS Clusters should have cluster control plane logging turned on")])]),e._v(" "),s("td",[s("code",[e._v("terraform-aws-modules/eks/aws/src/.terraform/modules/eks/main.tf:14-63")])]),e._v(" "),s("td",[e._v("Control plane controller manager logging is not enabled.")])]),e._v(" "),s("tr",[s("td",[e._v("10")]),e._v(" "),s("td",[s("code",[e._v("aws-eks-enable-control-plane-logging")])]),e._v(" "),s("td",[s("em",[e._v("MEDIUM")])]),e._v(" "),s("td",[s("em",[e._v("EKS Clusters should have cluster control plane logging turned on")])]),e._v(" "),s("td",[s("code",[e._v("terraform-aws-modules/eks/aws/src/.terraform/modules/eks/main.tf:14-63")])]),e._v(" "),s("td",[e._v("Control plane scheduler logging is not enabled.")])]),e._v(" "),s("tr",[s("td",[e._v("11")]),e._v(" "),s("td",[s("code",[e._v("aws-eks-encrypt-secrets")])]),e._v(" "),s("td",[s("em",[e._v("HIGH")])]),e._v(" "),s("td",[s("em",[e._v("EKS should have the encryption of secrets enabled")])]),e._v(" "),s("td",[s("code",[e._v("terraform-aws-modules/eks/aws/src/.terraform/modules/eks/main.tf:14-63")])]),e._v(" "),s("td",[e._v("Cluster does not have secret encryption enabled.")])]),e._v(" "),s("tr",[s("td",[e._v("12")]),e._v(" "),s("td",[s("code",[e._v("aws-eks-no-public-cluster-access")])]),e._v(" "),s("td",[s("em",[e._v("CRITICAL")])]),e._v(" "),s("td",[s("em",[e._v("EKS Clusters should have the public access disabled")])]),e._v(" "),s("td",[s("code",[e._v("terraform-aws-modules/eks/aws/src/.terraform/modules/eks/main.tf:26")])]),e._v(" "),s("td",[e._v("Public cluster access is enabled.")])]),e._v(" "),s("tr",[s("td",[e._v("13")]),e._v(" "),s("td",[s("code",[e._v("aws-eks-no-public-cluster-access-to-cidr")])]),e._v(" "),s("td",[s("em",[e._v("CRITICAL")])]),e._v(" "),s("td",[s("em",[e._v("EKS cluster should not have open CIDR range for public access")])]),e._v(" "),s("td",[s("code",[e._v("terraform-aws-modules/eks/aws/src/.terraform/modules/eks/main.tf:27")])]),e._v(" "),s("td",[e._v("Cluster allows access from a public CIDR: 0.0.0.0/0.")])])])]),e._v(" "),s("p",[e._v("Le cluster est public, les secrets sont en clair, le logging n'est pas activé... sans maitriser aws, il va falloir faire l'effort de regler chaque problème ou si on peut "),s("strong",[e._v("vraiment")]),e._v(" le justifier, annoter les tf pour exclure une remontée.")]),e._v(" "),s("p",[e._v("Je suis surpris du nombre de failles trouvées, il y en a trop pour détailler la resolution ici. Je le ferai peut etre un jour (ahahah non, je vais passer sur sideproject #85379876 c'est plus probable).")]),e._v(" "),s("h2",{attrs:{id:"infracost-le-nerf-de-la-guerre"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#infracost-le-nerf-de-la-guerre"}},[e._v("#")]),e._v(" infracost, le nerf de la guerre")]),e._v(" "),s("p",[e._v("Evidemment que le cloud est génial, c'est reactif, moderne, facile. On peut heberger n'importe quoi sur n'importe quel techno avec n'importe quelle puissance en quelques lignes de codes... et à la fin du mois, on recoit la facture. C'est le cofidis des datacenters, une reserve de puissance phenomenale accessible facilement... et un cout qui peut s'envoler tres haut, tres vite, trop tard.")]),e._v(" "),s("p",[e._v("Mais comme il existe des apps pour suivre et prevoir un budget (...) il existe une app pour prevoir les couts du cloud.")]),e._v(" "),s("p",[e._v("Infracost fournit pleins de trucs, des abonnements avec des dashboards pour suivre l'evolution des couts. Pour mon cas, je vais juste utiliser leur cli pour avoir une idée du cout de ce petit tutoriel bien ecrit (oui) et sans failles (non).")]),e._v(" "),s("p",[e._v("Il faut une api key meme pour le free tier, que je pose en var d'env dans mon shell")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("INFRACOST_API_KEY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("olalalacestsecret\n")])])]),s("p",[e._v("Et comme precedemment, le lancement se fait via docker")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--rm")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-e")]),e._v(" INFRACOST_API_KEY "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-v")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[e._v("$PWD")]),e._v("/:/code/ infracost/infracost:ci-0.10.11 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  breakdown "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--path")]),e._v(" /code/\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v(" OVERALL TOTAL                                                                                                      $170.24\n──────────────────────────────────\n53 cloud resources were detected:\n∙ 6 were estimated, 4 of which include usage-based costs, see https://infracost.io/usage-file\n∙ 47 were free, rerun with --show-skipped to see details\n")])])]),s("p",[e._v("$170 par mois! et encore, infracost me signale que certaines resources sont facturées a l'usage et ne sont pas dans le chiffrage.")]),e._v(" "),s("h2",{attrs:{id:"ensuite"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ensuite"}},[e._v("#")]),e._v(" Ensuite?")]),e._v(" "),s("p",[e._v("Tout ces outils s'integrent via github actions, mais cet article est deja assez long.")])])}),[],!1,null,null,null);s.default=r.exports}}]);